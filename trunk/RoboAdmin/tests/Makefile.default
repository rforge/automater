
include ../../Makevars

TESTS=${wildcard *.[rR] }

tests: testsite testfresh

.NOTPARALLEL: $(TESTS:%=%out) $(TESTS:%=%outfresh) # only for db conflicts

testsite: $(TESTS:%=%out)

$(TESTS:%=%out):%out:%   $(RPATH)/site-library
	@$(RM) $@ 
	@echo making $@ ...
	@$(RLIBS)  $(RB)  $< $@.fail
	@if [ -f $@.save ]; then  \
	  grep -v "trying URL" $@.save >$@.save.tmp ; \
	  grep -v "trying URL" $@.fail >$@.fail.tmp ; \
	  $(Rdiff) $@.save.tmp  $@.fail.tmp 1 ; fi
	@$(RM) $@.save.tmp $@.fail.tmp 
	@mv $@.fail $@


testfresh: $(TESTS:%=%outfresh)

$(TESTS:%=%outfresh):%outfresh: %   
	@$(RM) $@ 
	@echo making $@ ...
	@$(RLIBSFRESH)  $(RB)  $< $@.fail
	@if [ $(subst fresh,,$@.save) ]; then  \
	  grep -v "trying URL" $(subst fresh,,$@.save) >$@.save.tmp ; \
	  grep -v "trying URL" $@.fail >$@.fail.tmp ; \
	  $(Rdiff) $@.save.tmp  $@.fail.tmp 1 ; fi
	@$(RM) $@.save.tmp $@.fail.tmp 
	@mv $@.fail $@

clean:
	$(RM) *.Rout *.Routfresh *.Routfresh Rplots.pdf *.fail
	$(RM) *.Rout.fail.tmp *.Routfresh.fail.tmp
	$(RM) *.Rout.save.tmp *.Routfresh.save.tmp
