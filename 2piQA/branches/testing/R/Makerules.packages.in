# For use in the packages dirs
PAC=$(notdir $(shell pwd ))

# Makevars.site in the package directory has overrides for packages 
# that may be installed but not working or not made available for some 
# other reason.
-include Makevars-$(PAC).site

# Next is to set pkg-version file timestamp to the same value on all
#  test farm servers, since svn update does not preserve the timestamp.
# The first server to run with a package version should recognize this and
#  do the commit to update the $(PAC)-version file.

.PHONY: $(PAC)-version

default:$(PAC)-version

# NICE TO HIDE THIS ERROR MESSAGE, SINCE IT IS NOT A MAKE ERROR
# Error in packageVersion("nopack") : package \u2018nopack\u2019 not found
# Execution halted
# packageDescription is faster than installed.packages
installedPKG=${shell \
   echo 'packageVersion("$(PAC)")' | R --slave }

committedPKG=${shell head -1 $(PAC)-version }

PKGdate=${shell tail -1 $(PAC)-version }

# next generates PACKAGE-NOT-AVAILABLE either because it is not installed
# or because of the special specification in Makevars-$(PAC).site.
# Otherwise it generates any special requirements or restrictions.
Makevars:
	@echo "#auto-generated by make. Edits will be overwritten." >$@.tmp;
	@echo "#Put site specific requirements or restrictions "   >>$@.tmp;
	@echo "#  in Makevars-$(PAC).site "                        >>$@.tmp;
	@if [ -n '$(NOT-AVAILABLE)' ]  ; then \
	   echo "PACKAGE-NOT-AVAILABLE=$(NOT-AVAILABLE)" >>$@.tmp ; \
	elif [ -z '$(installedPKG)' ] ; then \
	   echo "PACKAGE-NOT-AVAILABLE=NOT INSTALLED"    >>$@.tmp ; \
	else   \
	   echo "RESOURCE-REQUIREMENTS=" >>$@.tmp ;                 \
	   echo "OS-RESTRICTIONS="       >>$@.tmp ;                 \
	fi
	@mv $@.tmp $@


#  THIS IS ASSUMING DIFFERENT VERSION IS NEWER VERSION!!!!
# If this fails the target may be generated anyway, but the usual trick of
#  writing first to $@.tmp will not work because the svn commit needs the
#  actual file. However, the next svn update may clean things up.
$(PAC)-version: Makevars
	@svn update
	@if [ -n '$(PACKAGE-NOT-AVAILABLE)' ]; then \
	    echo package $(PAC) not available ; exit 0 ; fi
	@if [ '$(committedPKG)' = '$(installedPKG)' ]; then \
	    touch --date "$(PKGdate)"  $@ ;\
 	  else \
 	    echo changed $(PAC) version ;\
 	    echo '$(installedPKG)'           >$@ ;\
 	    date "+%Y/%m/%d %H:%M:%S.%N %Z" >>$@ ;\
	    svn commit $@ -m '$@n updated to $(installedPKG).' ;\
 	  fi

clean:
	$(RM) Makevars Makevars.tmp

