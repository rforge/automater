# For use in the snippets dirs
PAC=$(notdir $(shell (cd ../ ; pwd )))
TESTS=${shell ls *.[rR] }


default: $(TESTS:%=STATUS-%-$(OS))

# snippet should throw an error if it fails, but that is not a failure of 
#  the make. The generated RESULT keeps track of tests that pass or fail.
#  Make keeps track of whether the test has been run or not with STATUS.

test: 
	@echo $(PAC)

$(TESTS:%=STATUS-%-$(OS)):STATUS-%-$(OS): %   ../../R-version  ../$(PAC)-version
	@echo doing $@
	@# the date not the content of this file that causes this target to run 
	@#grep check-needed $@ >/dev/null #could be used to throw error on content
	#svn lock $@ -m "testing in progress"
	@# the next never finishes with an error because of last touch /dev/null
	@($(RENV) R CMD BATCH  --vanilla $<  $<out-$(OS) ; \
	    export success=$$? ;  \
	    if [ 0 -eq $$success ]  ; then \
	         echo "passed" >RESULT-$<-$(OS)  ;    \
	    else echo "failed" >RESULT-$<-$(OS)  ;fi ;\
	    touch /dev/null)
	@echo "up-to-date" >$@ 
	#svn commit -m "ran $<"

clean:
	$(RM) *-$(OS) R-version Rplots*.pdf *.ps
	#svn unlock
	#svn update
